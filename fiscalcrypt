#!/usr/bin/env python3

"""
Main script to run fiscalcrypt tool

.. moduleauthor:: Armand BENETEAU <armand.beneteau@iot.bzh>

*Date: 24/04/2021*

*License:*
    Copyright (C) 2021 Armand Bénéteau

    This file is part of the Fiscal Crypt project.

    GNU General Public License Usage
    This file may be used under the terms of the GNU General \
    Public license version 3. This license is as published by the Free Software \
    Foundation and appearing in the file LICENSE included in the packaging \
    of this file. Please review the following information to ensure the GNU \
    General Public License requirements will be met \
    https://www.gnu.org/licenses/gpl-3.0.html.
"""
import json
import sys
from datetime import datetime
from dateutil.parser import isoparse
from decimal import *

from fiscal_crypt.price_finder.cryptowatch_finder import CryptowatchFinder
from fiscal_crypt.platforms.coinbase import CoinbaseInterface
from fiscal_crypt.platforms.coinbase_pro import CoinbaseProInterface
from fiscal_crypt.tax_processing.french_taxes import FrenchTaxes
from fiscal_crypt.fcrypt_logging import fcrypt_log

COINBASE_API_KEYS_FILE = "coinbase_keys.json"
COINBASE_PRO_API_KEYS_FILE = "coinbase_pro_keys.json"
CRYPTOWATCH_API_KEYS_FILE = "cryptowatch_keys.json"

if __name__ == "__main__":

    try:
        # Get the file containing the keys
        with open(COINBASE_API_KEYS_FILE) as keys_file:
            coinbase_keys = json.load(keys_file)

        if ("api_key" not in coinbase_keys) or ("api_secret" not in coinbase_keys):
            fcrypt_log.error("[CONFIG] Missing keys in configuration file")
            sys.exit(1)

        with open(CRYPTOWATCH_API_KEYS_FILE) as keys_file:
            cryptowatch_keys = json.load(keys_file)

        if ("api_key" not in cryptowatch_keys):
            fcrypt_log.error("[CONFIG] Missing keys in configuration file")
            sys.exit(1)

        with open(COINBASE_PRO_API_KEYS_FILE) as keys_file:
            coinbase_pro_keys = json.load(keys_file)

        if (("api_key" not in coinbase_pro_keys) or ("api_secret" not in coinbase_pro_keys) or
                ("api_passphrase" not in coinbase_pro_keys)):
            fcrypt_log.error("[CONFIG] Missing keys in configuration file")
            sys.exit(1)

        # Create the cryptowatch interface
        crypto_finder = CryptowatchFinder(cryptowatch_keys["api_key"], "coinbase-pro")

        # Create coinbase interface
        coinbase = CoinbaseInterface(coinbase_keys["api_key"], coinbase_keys["api_secret"], crypto_finder)

        # Create coinbase pro interface
        coinbase_pro = CoinbaseProInterface(
            coinbase_pro_keys["api_key"],
            coinbase_pro_keys["api_secret"],
            coinbase_pro_keys["api_passphrase"],
            crypto_finder)

        # value = coinbase.get_wallet_value_at("XLM", "EUR", isoparse("2020-02-14T00:30:00Z"))
        # normal_value = value.normalize()

        # print("!!!!!!! Calculating the wallet value for XLM")
        # value = coinbase_pro.get_wallet_value_at("XLM", "EUR", isoparse("2020-02-14T00:30:00Z"))
        # normal_value = value.normalize()

        # value = coinbase.get_all_wallets_value("EUR", isoparse("2020-02-14T00:30:00Z"))
        # normal_value = value.normalize()

        # Round to two places
        # TWOPLACES = Decimal(10) ** -2
        # display_value = normal_value.quantize(TWOPLACES)

        # print(f"VALUE {str(display_value)} €")

        # # Get all the sell transaction on Coinbase Pro
        # print("!!!!!!! Getting all sell transaction on Coinbase Pro !!!!")
        # all_transactions = coinbase_pro.all_sell_transactions_generator("EUR", isoparse("2021-07-01T00:00:00Z"))
        # for transaction in all_transactions:
        #     print("Transaction: ", transaction)

        # # Get all the buy transaction on Coinbase Pro
        # print("!!!!!!! Getting all buy transaction on Coinbase Pro !!!!")
        # all_transactions = coinbase_pro.all_buy_transactions_generator("EUR", isoparse("2021-07-01T00:00:00Z"))
        # for transaction in all_transactions:
        #     print("Transaction: ", transaction)

        # # Get all the sell transaction on Coinbase
        # print("!!!!!!! Getting all sell transaction on Coinbase !!!!")
        # all_transactions = coinbase.all_sell_transactions_generator("EUR", isoparse("2021-07-01T00:00:00Z"))
        # for transaction in all_transactions:
        #     print("Transaction: ", transaction)

        # # Get all the buy transaction on Coinbase
        # print("!!!!!!! Getting all buy transaction on Coinbase !!!!")
        # all_transactions = coinbase.all_buy_transactions_generator("EUR", isoparse("2021-07-01T00:00:00Z"))
        # for transaction in all_transactions:
        #     print("Transaction: ", transaction)

        tax_model = FrenchTaxes("EUR", [coinbase, coinbase_pro])

        # Call the function allowing to calculate the taxes
        tax_model.get_tax_declaration_for("EUR", isoparse("2020-01-01T00:00:00Z"), isoparse("2020-12-31T23:59:59Z"))

    except Exception as err:
        fcrypt_log.error("[Exception] The following exception occured while fiscalcrypt was running:", str(err))
        sys.exit(1)
